name: Deploy to GKE with Helm

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
  IMAGE_NAME: hrgf-app

jobs:
  # ---------------------------------------------------------
  # JOB 1: Build and Push Image
  # ---------------------------------------------------------
  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.sha_short }}
      image_uri: ${{ steps.vars.outputs.image_uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev --quiet

      - name: Set variables
        id: vars
        run: |
          SHA_SHORT=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_URI="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/${IMAGE_NAME}"

          printf "sha_short=%s\n" "$SHA_SHORT" >> "$GITHUB_OUTPUT"
          printf "image_uri=%s\n" "$IMAGE_URI" >> "$GITHUB_OUTPUT"

          echo "LOCAL_TAG=$SHA_SHORT" >> $GITHUB_ENV
          echo "LOCAL_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build -f docker/Dockerfile \
            -t ${LOCAL_URI}:${LOCAL_TAG} .

      - name: Push image
        run: |
          docker push ${LOCAL_URI}:${LOCAL_TAG}

  # ---------------------------------------------------------
  # JOB 2: Security Scan
  # ---------------------------------------------------------
  security_scan:
    name: Trivy Security Scan
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev --quiet

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ needs.build.outputs.image_uri }}:${{ needs.build.outputs.image_tag }}
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'table'

  # ---------------------------------------------------------
  # JOB 3: Deploy to GKE
  # ---------------------------------------------------------
  deploy:
    name: Deploy to GKE
    needs: [build, security_scan]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} \
            --zone ${GKE_ZONE} \
            --project ${GCP_PROJECT_ID}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install hrgf-app helm/hrgf-app \
            --set image.repository=${{ needs.build.outputs.image_uri }} \
            --set image.tag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 5m
