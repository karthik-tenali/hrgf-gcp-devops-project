name: Deploy to GKE with Helm

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
  IMAGE_NAME: hrgf-app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          IMAGE_URI="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPO}/${IMAGE_NAME}"

          docker build -f docker/Dockerfile \
            -t ${IMAGE_URI}:${{ github.sha }} .

          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_URI }}:${{ github.sha }}
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'table'

      - name: Push image
        run: |
          docker push ${{ env.IMAGE_URI }}:${{ github.sha }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${GKE_CLUSTER_NAME} \
            --zone ${GKE_ZONE} \
            --project ${GCP_PROJECT_ID}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install hrgf-app helm/hrgf-app \
            --set image.repository=${{ env.IMAGE_URI }} \
            --set image.tag=${{ github.sha }} \
            --wait \
            --timeout 5m
