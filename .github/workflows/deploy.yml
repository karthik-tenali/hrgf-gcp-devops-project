name: Deploy to GKE with Helm

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REPO }}
  IMAGE_NAME: hrgf-app
  # Force legacy Docker behavior to avoid Buildx argument errors
  DOCKER_BUILDKIT: 0

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      
      - name: Set Image Variables
        run: |
          # Use cut to get 7 chars and save to GITHUB_ENV
          CLEAN_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          CLEAN_URI="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}"
          
          echo "IMAGE_TAG=${CLEAN_TAG}" >> $GITHUB_ENV
          echo "IMAGE_URI=${CLEAN_URI}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          # --builder default is the key fix 
          docker build --builder default -f docker/Dockerfile -t ${{ env.IMAGE_URI }}:${{ env.IMAGE_TAG }} .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_URI }}:${{ env.IMAGE_TAG }}
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'table'

      - name: Push image
        run: |
          docker push ${{ env.IMAGE_URI }}:${{ env.IMAGE_TAG }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
            --zone ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install hrgf-app helm/hrgf-app \
            --set image.repository=${{ env.IMAGE_URI }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --wait \
            --timeout 5m